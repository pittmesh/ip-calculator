<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PittMesh IP Address calculator</title>
    <style>
      #transcript {
        border: 2px groove threedface;
        font-family: monospace;
        padding: 0.35em 0.75em 0.75em 0.625em;
        margin: 8px 2px;
      }

      @media all and (min-width: 400px) {
        .output {
          white-space: nowrap;
        }
        .output label {
          display: inline-block;
          width: 4.5em;
        }
      }

      @media all and (max-width: 479px) {
        .input input {
          width: calc(100% - 9.25em);
        }
        .input label {
          display: block;
          text-align: center;
        }
        .output input {
          width: calc(100% - 12.5em);
        }
        h1 {
          text-align: center;
        }
      }

      @media all and (max-width: 399px) {
        .output {
          white-space: normal;
        }
        .output input {
          width: calc(100% - 7.25em);
        }
        .output label {
          display: block;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <h1>PittMesh IP address calculator</h1>
    <hr/>
    <p>
    This tool takes a router's MAC address and calculates the two IP addresses
    that the router needs: mesh interface and wlan client interface.
    </p>
    <form id="calc" onSubmit="return calc();">
      <fieldset form="calc">
        <legend>Input</legend>
        <span class="input">
          <label for="mac">MAC address</label>
          <input name="mac" id="mac" placeholder="de:ad:be:ef:00:00"/>
          <button type="submit">Calculate</button>
        </span>
      </fieldset>
      <fieldset form="calc">
        <legend>Output</legend>
        <span class="output">
          <label for="mesh">Mesh IP</label>
          <input name="mesh" id="mesh" disabled="disabled"/>
          <button id="copy-mesh" type="button">copy</button>
        </span>
        <span class="output">
          <label for="wlan">WLAN IP</label>
          <input name="wlan" id="wlan" disabled="disabled"/>
          <button id="copy-wlan" type="button">copy</button>
        </span>
      </fieldset>
    </form>
    <div id="transcript">
      <p>Log messages will appear here.</p>
      <p><a href="https://github.com/pittmesh/ip-calculator">Fork ip-calculator on Github</a>.</p>
    </div>
    <script>
      "use strict";
      //
      // constants
      //
      var standardMfgs = [];
      // to generate from an www.adminsub.net/mac-address-finder/* list, do this in a browser console:
      // [].slice.call(document.getElementsByClassName("bl558_line_2")).map(function(el){ return el.firstChild.firstChild; });
      var ubiquitiMacs = ["F09FC2", "DC9FDB", "802AA8", "687251", "44D9E7", "24A43C", "0418D6", "002722", "00156D"];
      standardMfgs.push("Ubiquiti");
      var tplinkMacs = ["FCD733", "F8D111", "F81A67", "F4F26D", "F4EC38", "F483CD", "F0F336", "EC888F", "EC26CA", "EC172F", "E8DE27", "E894F6", "E4D332", "E005C5", "D85D4C", "D8150D", "D4016D", "D0C7C0", "CC3429", "C4E984", "C46E1F", "C06118", "C04A00", "BCD177", "BC4699", "B0487A", "A8574E", "A8154D", "A42BB0", "A0F3C1", "9C216A", "940C6D", "90F652", "90AE1B", "8C210A", "882593", "808917", "78A106", "74EA3A", "6CE873", "647002", "6466B3", "645601", "60E327", "5C899A", "5C63BF", "54E6FC", "54C80F", "50FA84", "50C7BF", "50BD5F", "44B32D", "40169F", "3C46D8", "388345", "30B5C2", "282CB2", "20DCE6", "1CFA68", "14E6E4", "14CF92", "14CC20", "148692", "147590", "10FEED", "0C8268", "0C722C", "085700", "002719", "002586", "0023CD", "002127", "001D0F", "0019E0", "001478", "000AEB"];
      standardMfgs.push("TP-Link");

      var knownMacs = ubiquitiMacs.concat(tplinkMacs);

      var meshPrefix = [100];
      var wlanPrefix = [10];
      var wlanSuffix = [1];

      var macEl = document.getElementById('mac');
      var meshEl = document.getElementById('mesh');
      var wlanEl = document.getElementById('wlan');
      var transcriptEl = document.getElementById('transcript');

      function calc() {
        var mac = macEl.value;
        var macArray = mac.split(/[:-]/);

        if(macArray.length != 6) {
          displayError("The MAC address does not appear to be valid. Ensure that there are six octets, separated by colons (:) or hyphens (-).");
          return false;
        }

        checkForStandardMfgs(firstThreeOctets(macArray));

        var macArrayDecimals = convertHexToDecimals(macArray);
        var meshIP = calcMeshIP(lastThreeOctets(macArrayDecimals));
        var wlanIP = calcWlanIP(lastTwoOctets(macArrayDecimals));

        meshEl.value = meshIP;
        wlanEl.value = wlanIP;

        displaySuccess("MAC Address "+macArray.join(":")+" calculates to Mesh IP "+meshIP+" WLAN IP "+wlanIP);
        return false;
      }

      function calcMeshIP(lastThree) {
        return makeIP(meshPrefix.concat(lastThree));
      }

      function calcWlanIP(lastTwo) {
        return makeIP(wlanPrefix.concat(lastTwo).concat(wlanSuffix));
      }

      function makeIP(arr) { return arr.join("."); }

      function checkForStandardMfgs(firstThree) {
        if(-1 == knownMacs.indexOf(firstThree.join(""))){
          displayError(
            "The MAC address does not appear to be from a PittMesh standard manufacturer (" +
            standardMfgs.join(", ") +
            "). The IP address calculation may be invalid.");
        }
      }

      function log(text, style) {
        var date = new Date();
        var timestamp = "["+[('0'+date.getHours()).slice(-2), ('0'+date.getMinutes()).slice(-2), ('0'+date.getSeconds()).slice(-2)].join(":")+"]";
        transcriptEl.appendFirst(createLogLineElement(timestamp, text, style));
        console.log("[%.2d:%.2d:%.2d] %c"+text, date.getHours(), date.getMinutes(), date.getSeconds(), style);
      }

      function displayError(text) {
        log(text, 'color:red; font-family:helvetica,sans-serif; font-weight:bold; text-shadow:0 1px 2px rgba(0,0,0,.5);');
      }

      function displaySuccess(text) {
        log(text, 'color:green; font-family:helvetica,sans-serif; font-weight:bold; text-shadow:0 1px 2px rgba(0,0,0,.5);');
      }

      function displayWarning(text) {
        log(text, 'background-color:gray; color:yellow; display: block; font-family:helvetica,sans-serif; font-weight:bold; text-shadow:0 1px 2px rgba(0,0,0,.5); width: 100%;');
      }

      function createLogLineElement(time, text, style) {
        var line     = document.createElement("p");
        var lineTime = document.createElement("span");
        var lineText = document.createElement("span");
        lineTime.appendChild(document.createTextNode(time));
        lineText.appendChild(document.createTextNode(text));
        lineTime.classList.add("time");
        lineText.classList.add("text");
        lineText.style = style;
        line.appendChild(lineTime);
        line.appendChild(lineText);
        return line;
      }

      function convertHexToDecimals(arr) { return arr.map( function(h) { return parseInt(h, 16); } ); }
      function firstThreeOctets(arr) { return arr.slice(0, 3); }
      function lastThreeOctets(arr) { return arr.slice(3, 6); }
      function lastTwoOctets(arr) { return arr.slice(4, 6); }

      HTMLElement.prototype.appendFirst = function(childNode){
          if(this.firstChild)
            this.insertBefore(childNode, this.firstChild);
          else
            this.appendChild(childNode);
      };

      function doCopy(element) {
        element.disabled = false;
        element.select();
        try {
          var successful = document.execCommand('copy');
          var msg = successful ? 'Successfully' : 'Unsuccessfully';
          displaySuccess(msg + " copied to clipboard.");
        } catch (err) {
          displayError("Oops, unable to copy to clipboard. You are on your own.");
        } finally {
          element.disabled = true;
        }
      }

      function copyInput(element) {
        return function(event) {
          event.preventDefault();
          doCopy(element);
        }
      }

      document.getElementById("copy-mesh").addEventListener('click', copyInput(meshEl));
      document.getElementById("copy-wlan").addEventListener('click', copyInput(wlanEl));
    </script>
  </body>
</html>
